# Modern Steam OpenID strategy for Passport

## Important Note

This package is a forked version of the [modern-passport-steam](https://github.com/easton36/modern-steam-passport) package originally created by [easton36](https://github.com/easton36). This fork includes the following enhancements:

1. Added support for the `passReqToCallback` option, allowing the request object to be passed to the verify callback.
2. Added TypeScript type definitions (`index.d.ts`) for improved developer experience and type safety.
3. Fixed small issue in relation to `realm` validation.
4. Added support for proxy servers to help avoid rate limiting.

These improvements aim to make the package more flexible and easier to use in TypeScript projects while maintaining the security and modernity of the original implementation.

## Description

A modern [Passport](https://github.com/jaredhanson/passport) strategy for authenticating
with [Steam](http://steamcommunity.com/) using OpenID 2.0. Inspired by the original [passport-steam](https://github.com/liamcurry/passport-steam/) strategy, and DoctorMcKay's [node-steam-signin](https://github.com/DoctorMcKay/node-steam-signin) library.

There is currently a vulnerability in the original [passport-steam](https://github.com/liamcurry/passport-steam/) library that allows you to authenticate as any steam account.

## Installation

```bash
$ npm i --save @fabiansharp/modern-passport-steam
```

## Contents

- [Options](#options)
- [Usage](#usage)
- [Rate Limiting & Proxy Support](#rate-limiting--proxy-support)
- [Examples](#examples)

## Options

This strategy takes an options object with the following properties:

- `returnUrl` - The URL to which Steam will redirect the user after authentication. This should be the URL of the route that calls `passport.authenticate('steam')`.
- `realm` - The URL to which Steam will redirect the user after authentication. This should be the root URL of your website.
- `fetchSteamLevel` - Whether or not to fetch the user's Steam level. Defaults to `false`. Requires an API key to be provided.
- `fetchUserProfile` - Whether or not to fetch the user's profile. Defaults to `true`. Requires an API key to be provided.
- `passReqToCallback` - When `true`, `req` is the first argument to the verify callback. Defaults to `false`.
- `apiKey` - A Steam API key to use for fetching the user's Steam level and profile. Can be a string or a function that returns a string. Can be async if you need to fetch the key from a remote service!
	- If you do not explicity set `fetchUserProfile` to `false`, an error will be thrown if you do not provide an API key.
	- If you do not provide an API key, the first parameter passed to the verify callback will be the SteamID object.
	- If you provide an API key, the first parameter passed to the verify callback will be the full user object. (See examples below)
- `proxies` - An array of proxy URLs to use for Steam API requests. Helps avoid rate limiting (429 errors). Supports both HTTP and HTTPS proxies. Defaults to `[]` (no proxies).
- `maxRetries` - Maximum number of retry attempts for Steam API requests when rate limited. Defaults to `3`.
- `retryDelay` - Base delay in milliseconds between retry attempts. Uses exponential backoff with jitter. Defaults to `1000`.

Example options object:
```js
{
	returnUrl: 'http://localhost:3000/login/return',
	realm: 'http://localhost:3000/',
	fetchSteamLevel: true, // Defaults to false, makes an extra request to fetch the user's Steam level
	fetchUserProfile: true, // Defaults to true if an API key is provided
	passReqToCallback: false, // Defaults to false, if true, req is the first argument to the verify callback
	proxies: [ // Optional: Array of proxy URLs to help avoid rate limiting
		'http://proxy1.example.com:8080',
		'http://proxy2.example.com:3128',
		'https://secure-proxy.example.com:8080'
	],
	maxRetries: 3, // Optional: Maximum retry attempts on rate limit (default: 3)
	retryDelay: 1000, // Optional: Base delay between retries in ms (default: 1000)
	apiKey: () => {
		// You should return your Steam API key here
		// For security, you should use environment variables or a secure key management service
		// Can be a string or a function that returns a string
		// Can be async if you need to fetch the key from a remote service!
		return 'MY_STEAM_API_KEY';
	}
}
```

## Usage

#### Require Strategy

```js
const SteamStrategy = require('modern-passport-steam');
```

#### Configure Strategy

If you want to fetch the user's Steam level and profile, you will need to provide a Steam API key. You can get one [here](https://steamcommunity.com/dev/apikey).
If you do not pass an api key, the first parameter passed to the verify callback will be the SteamID object, as you can see in the examples below.

With Profile Fetching:
```js
passport.use(new SteamStrategy({
	returnUrl: 'http://localhost:3000/login/return',
	realm: 'http://localhost:3000/',
	fetchSteamLevel: true,
	fetchUserProfile: true,
	passReqToCallback: false,
	apiKey: () => {
		// You should return your Steam API key here
		// For security, you should use environment variables or a secure key management service
		// Can be a string or a function that returns a string
		// Can be async if you need to fetch the key from a remote service!
		return 'MY_STEAM_API_KEY';
	}
}, (user, done) => {
	// Here you would look up the user in your database using the SteamID
	// For this example, we're just passing the full user object back

	done(null, user);
}));
```

With `passReqToCallback`:
```js
passport.use(new SteamStrategy({
    returnUrl: 'http://localhost:3000/login/return',
    realm: 'http://localhost:3000/',
    passReqToCallback: true,
    apiKey: 'YOUR_STEAM_API_KEY'
}, (req, user, done) => {
    // 'req' is now available here
    // You can access request-specific information if needed
    done(null, user);
}));
```

Example user object if you pass an API key:
```js
{
  SteamID: SteamID { universe: 1, type: 1, instance: 1, accountid: 893472231 },
  profile: {
    steamid: '76561198853737959',
    communityvisibilitystate: 3,
    profilestate: 1,
    personaname: 'sampli',
    commentpermission: 1,
    profileurl: 'https://steamcommunity.com/id/shamp/',
    avatar: 'https://avatars.steamstatic.com/979e4a6baa364403e1dc268a52034162044ae391.jpg',
    avatarmedium: 'https://avatars.steamstatic.com/979e4a6baa364403e1dc268a52034162044ae391_medium.jpg',
    avatarfull: 'https://avatars.steamstatic.com/979e4a6baa364403e1dc268a52034162044ae391_full.jpg',
    avatarhash: '979e4a6baa364403e1dc268a52034162044ae391',
    lastlogoff: 1716699862,
    personastate: 0,
    primaryclanid: '103582791429521408',
    timecreated: 1534350460,
    personastateflags: 0
  },
  level: 52
}
```

Without Profile Fetching:
```js
passport.use(new SteamStrategy({
	returnUrl: 'http://localhost:3000/login/return',
	realm: 'http://localhost:3000/',
	fetchUserProfile: false // Must explicitly set this to false if you do not want to fetch the user's profile
}, (SteamID, done) => {
	// Here you would look up the user in your database using the SteamID
	// For this example, we're just passing the SteamID64 back as the user id
	const user = {
		id: SteamID.getSteamID64()
	};

	done(null, user);
}));
```

#### Authenticate Requests

Use `passport.authenticate()`, specifying the `'steam'` strategy, to authenticate requests.

For example, as route middleware in an [Express](http://expressjs.com/) application:

```js
app.get('/login', passport.authenticate('steam'));

app.get('/login/return', passport.authenticate('steam', {
	failureRedirect: '/login'
}), (req, res) => {
	// Successful authentication, redirect home.
	res.redirect('/');
});
```

## Rate Limiting & Proxy Support

Steam's API has rate limits that can result in 429 (Too Many Requests) errors, especially in high-traffic applications. This package includes built-in support for handling rate limits through:

### Automatic Retry Logic
- Automatically retries failed requests up to `maxRetries` times (default: 3)
- Uses exponential backoff with jitter to avoid overwhelming Steam's servers
- Only retries on 429 rate limit errors, fails fast on other HTTP errors

### Proxy Rotation
- Supports rotating through multiple proxy servers to distribute requests
- Helps avoid IP-based rate limiting by spreading requests across different IPs
- Simple round-robin rotation between provided proxies
- Supports both HTTP and HTTPS proxy servers

### Example with Proxy Support
```js
passport.use(new SteamStrategy({
	returnUrl: 'http://localhost:3000/login/return',
	realm: 'http://localhost:3000/',
	fetchSteamLevel: true,
	proxies: [
		'http://proxy1.example.com:8080',
		'http://proxy2.example.com:3128'
	],
	maxRetries: 5,
	retryDelay: 2000,
	apiKey: process.env.STEAM_API_KEY
}, (user, done) => {
	done(null, user);
}));
```

## Examples

There is a basic example using express in the [examples folder](https://github.com/easton36/modern-steam-passport/tree/master/examples/express).

## License

[The MIT License](https://github.com/easton36/modern-steam-passport/blob/master/LICENSE)