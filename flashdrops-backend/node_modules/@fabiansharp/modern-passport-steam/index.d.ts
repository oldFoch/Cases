import { Strategy as PassportStrategy } from 'passport-strategy';
import { Request } from 'express';

declare class SteamID {
    constructor(id: string);
    getSteamID64(): string;
}

export interface SteamProfile {
    steamid: string;
    communityvisibilitystate: number;
    profilestate: number;
    personaname: string;
    profileurl: string;
    avatar: string;
    avatarmedium: string;
    avatarfull: string;
    avatarhash: string;
    personastate: number;
    realname?: string;
    primaryclanid?: string;
    timecreated?: number;
    personastateflags?: number;
    loccountrycode?: string;
    locstatecode?: string;
    loccityid?: number;
}

export interface SteamUser {
    SteamID: SteamID;
    profile?: SteamProfile;
    level?: number;
}

export interface SteamStrategyOptionsBase {
    returnUrl: string;
    realm: string;
    apiKey: string | (() => string | Promise<string>);
    fetchUserProfile?: boolean;
    fetchSteamLevel?: boolean;
}

export interface SteamStrategyOptionsWithoutRequest extends SteamStrategyOptionsBase {
    passReqToCallback?: false;
}

export interface SteamStrategyOptionsWithRequest extends SteamStrategyOptionsBase {
    passReqToCallback: true;
}

export type SteamStrategyOptions = SteamStrategyOptionsWithoutRequest | SteamStrategyOptionsWithRequest;

export type VerifyFunction = (
    user: SteamUser,
    done: (error: any, user?: any, info?: any) => void
) => void;

export type VerifyFunctionWithRequest = (
    req: Request,
    user: SteamUser,
    done: (error: any, user?: any, info?: any) => void
) => void;

export class Strategy<T extends SteamStrategyOptions = SteamStrategyOptionsWithoutRequest> extends PassportStrategy {
    constructor(options: T, verify: T extends SteamStrategyOptionsWithRequest ? VerifyFunctionWithRequest : VerifyFunction);
    authenticate(req: Request): void;
    name: string;
}

export namespace Strategy {
    export function verifyLogin(url: string, expectedRealm: string): Promise<SteamID>;
    export function buildAuthUrl(realm: string, returnUrl: string): string;
    export function canonicalizeRealm(realm: string): string;

    export function fetchSteamLevel(steamId: string, apiKey: string): Promise<number>;
    export function fetchSteamProfile(steamId: string, apiKey: string): Promise<SteamProfile>;

    export const REQUIRED_PARAMS: string[];
    export const REQUIRED_SIGNED_PARAMS: string[];
}

export default Strategy;